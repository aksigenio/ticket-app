<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Купить билет</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:12px;background:#fafafa}
  h2{margin:6px 0 12px}
  .legend{display:flex;gap:12px;margin-bottom:10px;align-items:center}
  .legend span{display:inline-flex;align-items:center;gap:6px;font-size:0.95rem}
  .sw{width:14px;height:14px;border-radius:3px;display:inline-block}
  .hall{position:relative;max-width:980px;margin:10px auto;height:1400px;background:#fff;border:1px solid #eee;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
  .stage{position:absolute; left:8%; right:8%; top:4%; height:16%; background:#e8e0cb; display:flex;align-items:center;justify-content:center; font-weight:700; color:#333; border-radius:4px}
  .seat{position:absolute;border-radius:6px; display:flex;align-items:center;justify-content:center;color:#fff;font-size:0.7rem;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,0.08);border:2px solid rgba(255,255,255,0.6)}
  .available{background:rgba(0,160,0,0.9)}
  .pending{background:rgba(240,160,0,0.95)}
  .sold{background:rgba(200,0,0,0.95);cursor:default;opacity:0.85}
  .seat:hover{transform:scale(1.06)}
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal.open{display:flex}
  .card{background:#fff;padding:14px;border-radius:8px;width:90%;max-width:420px;box-shadow:0 6px 24px rgba(0,0,0,0.2)}
  input[type=text], input[type=email]{width:100%;padding:8px;margin-top:6px;box-sizing:border-box}
  input[type=file]{margin-top:8px}
  .btn{padding:8px 12px;border-radius:6px;border:none;background:#1e73be;color:#fff;cursor:pointer}
  .btn.grey{background:#777}
  #formMsg{margin-top:8px;font-size:0.95rem}
  .topbar{max-width:980px;margin:0 auto 8px;display:flex;justify-content:space-between;align-items:center}
  @media (max-width:600px){ .seat{font-size:0.6rem} }
</style>
</head>
<body>
  <div class="topbar">
    <h2>Купить билет — план зала</h2>
    <div class="legend">
      <span><i class="sw" style="background:rgba(0,160,0,0.9)"></i> available</span>
      <span><i class="sw" style="background:rgba(240,160,0,0.95)"></i> pending</span>
      <span><i class="sw" style="background:rgba(200,0,0,0.95)"></i> sold</span>
    </div>
  </div>

  <div class="hall" id="hall">
    <div class="stage">PALCO / Сцена</div>
    <!-- seats will be added here -->
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="card">
      <h3 id="modalTitle">Заказать место</h3>
      <form id="buyForm">
        <input type="hidden" id="seatId" />
        <label>Имя<input type="text" id="name" required></label>
        <label>Фамилия<input type="text" id="surname"></label>
        <label>Email<input type="email" id="email" required></label>
        <label>Подтверждение оплаты (скрин/файл)*<input type="file" id="receipt" accept="image/*,application/pdf" required></label>
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
          <button id="cancelBtn" class="btn grey" type="button">Отмена</button>
          <button class="btn" type="submit">Отправить</button>
        </div>
        <div id="formMsg"></div>
      </form>
    </div>
  </div>

<script>
/* ---------- ВСТАВЬ СЮДА ТВОЙ API URL ------------- */
const API_URL = 'https://script.google.com/macros/s/AKfycbyB8BTuStNLun7ZSM3WEkVhqvkKXQA6dJOdKrtmR8scnCphRakjkmLuQtm6-ja2MjX5HA/exec'; // <-- ВСТАВЬ Web app URL

/* ---------- СХЕМА РЯДОВ (сумма = 172) -----------
   rowsCounts — массив: кол-во кресел в каждом ряду, сверху вниз */
const rowsCounts = [16,15,15,15,14,12,12,12,12,12,10,10,8,9]; // total 172

/* Параметры размещения (проценты) */
const hallPaddingLeft = 6;   // % слева рамки
const hallPaddingRight = 6;  // % справа рамки
const topStart = 22;         // % от верхней границы блока hall, где начинаются ряды
const rowVGap = 4.5;         // вертикальный шаг между рядами (%)
const seatW = 3.5;           // ширина места (%)
const seatH = 3.5;           // высота (%)

/* Авто-генерация SEATS_CONFIG (id,left,top,w,h) */
const SEATS_CONFIG = [
  {"id":"1","left":14,"top":18,"w":3.5,"h":3.5},
  {"id":"2","left":19.1,"top":18,"w":3.5,"h":3.5},
  {"id":"3","left":24.2,"top":18,"w":3.5,"h":3.5},
  {"id":"4","left":29.3,"top":18,"w":3.5,"h":3.5},
  {"id":"5","left":34.4,"top":18,"w":3.5,"h":3.5},
  {"id":"6","left":39.5,"top":18,"w":3.5,"h":3.5},
  {"id":"7","left":44.6,"top":18,"w":3.5,"h":3.5},
  {"id":"8","left":49.7,"top":18,"w":3.5,"h":3.5},
  {"id":"9","left":54.8,"top":18,"w":3.5,"h":3.5},
  {"id":"10","left":59.9,"top":18,"w":3.5,"h":3.5},
  {"id":"11","left":65,"top":18,"w":3.5,"h":3.5},
  {"id":"12","left":70.1,"top":18,"w":3.5,"h":3.5},
  {"id":"13","left":75.2,"top":18,"w":3.5,"h":3.5},
  {"id":"14","left":80.3,"top":18,"w":3.5,"h":3.5},
  {"id":"15","left":85.4,"top":18,"w":3.5,"h":3.5},
  {"id":"16","left":90.5,"top":18,"w":3.5,"h":3.5},

  {"id":"17","left":12.9,"top":24,"w":3.5,"h":3.5},
  {"id":"18","left":18,"top":24,"w":3.5,"h":3.5},
  {"id":"19","left":23.1,"top":24,"w":3.5,"h":3.5},
  {"id":"20","left":28.2,"top":24,"w":3.5,"h":3.5},
  {"id":"21","left":33.3,"top":24,"w":3.5,"h":3.5},
  {"id":"22","left":38.4,"top":24,"w":3.5,"h":3.5},
  {"id":"23","left":43.5,"top":24,"w":3.5,"h":3.5},
  {"id":"24","left":48.6,"top":24,"w":3.5,"h":3.5},
  {"id":"25","left":53.7,"top":24,"w":3.5,"h":3.5},
  {"id":"26","left":58.8,"top":24,"w":3.5,"h":3.5},
  {"id":"27","left":63.9,"top":24,"w":3.5,"h":3.5},
  {"id":"28","left":69,"top":24,"w":3.5,"h":3.5},
  {"id":"29","left":74.1,"top":24,"w":3.5,"h":3.5},
  {"id":"30","left":79.2,"top":24,"w":3.5,"h":3.5},
  {"id":"31","left":84.3,"top":24,"w":3.5,"h":3.5},
  {"id":"32","left":89.4,"top":24,"w":3.5,"h":3.5},
  {"id":"33","left":94.5,"top":24,"w":3.5,"h":3.5},

  {"id":"34","left":14,"top":30,"w":3.5,"h":3.5},
  {"id":"35","left":19.1,"top":30,"w":3.5,"h":3.5},
  {"id":"36","left":24.2,"top":30,"w":3.5,"h":3.5},
  {"id":"37","left":29.3,"top":30,"w":3.5,"h":3.5},
  {"id":"38","left":34.4,"top":30,"w":3.5,"h":3.5},
  {"id":"39","left":39.5,"top":30,"w":3.5,"h":3.5},
  {"id":"40","left":44.6,"top":30,"w":3.5,"h":3.5},
  {"id":"41","left":49.7,"top":30,"w":3.5,"h":3.5},
  {"id":"42","left":54.8,"top":30,"w":3.5,"h":3.5},
  {"id":"43","left":59.9,"top":30,"w":3.5,"h":3.5},
  {"id":"44","left":65,"top":30,"w":3.5,"h":3.5},
  {"id":"45","left":70.1,"top":30,"w":3.5,"h":3.5},
  {"id":"46","left":75.2,"top":30,"w":3.5,"h":3.5},
  {"id":"47","left":80.3,"top":30,"w":3.5,"h":3.5},
  {"id":"48","left":85.4,"top":30,"w":3.5,"h":3.5},
  {"id":"49","left":90.5,"top":30,"w":3.5,"h":3.5},

  {"id":"50","left":15.1,"top":36,"w":3.5,"h":3.5},
  {"id":"51","left":20.2,"top":36,"w":3.5,"h":3.5},
  {"id":"52","left":25.3,"top":36,"w":3.5,"h":3.5},
  {"id":"53","left":30.4,"top":36,"w":3.5,"h":3.5},
  {"id":"54","left":35.5,"top":36,"w":3.5,"h":3.5},
  {"id":"55","left":40.6,"top":36,"w":3.5,"h":3.5},
  {"id":"56","left":45.7,"top":36,"w":3.5,"h":3.5},
  {"id":"57","left":50.8,"top":36,"w":3.5,"h":3.5},
  {"id":"58","left":55.9,"top":36,"w":3.5,"h":3.5},
  {"id":"59","left":61,"top":36,"w":3.5,"h":3.5},
  {"id":"60","left":66.1,"top":36,"w":3.5,"h":3.5},
  {"id":"61","left":71.2,"top":36,"w":3.5,"h":3.5},
  {"id":"62","left":76.3,"top":36,"w":3.5,"h":3.5},
  {"id":"63","left":81.4,"top":36,"w":3.5,"h":3.5},
  {"id":"64","left":86.5,"top":36,"w":3.5,"h":3.5},

  {"id":"65","left":15.1,"top":42,"w":3.5,"h":3.5},
  {"id":"66","left":20.2,"top":42,"w":3.5,"h":3.5},
  {"id":"67","left":25.3,"top":42,"w":3.5,"h":3.5},
  {"id":"68","left":30.4,"top":42,"w":3.5,"h":3.5},
  {"id":"69","left":35.5,"top":42,"w":3.5,"h":3.5},
  {"id":"70","left":40.6,"top":42,"w":3.5,"h":3.5},
  {"id":"71","left":45.7,"top":42,"w":3.5,"h":3.5},
  {"id":"72","left":50.8,"top":42,"w":3.5,"h":3.5},
  {"id":"73","left":55.9,"top":42,"w":3.5,"h":3.5},
  {"id":"74","left":61,"top":42,"w":3.5,"h":3.5},
  {"id":"75","left":66.1,"top":42,"w":3.5,"h":3.5},
  {"id":"76","left":71.2,"top":42,"w":3.5,"h":3.5},
  {"id":"77","left":76.3,"top":42,"w":3.5,"h":3.5},
  {"id":"78","left":81.4,"top":42,"w":3.5,"h":3.5},

  {"id":"79","left":15.1,"top":48,"w":3.5,"h":3.5},
  {"id":"80","left":20.2,"top":48,"w":3.5,"h":3.5},
  {"id":"81","left":25.3,"top":48,"w":3.5,"h":3.5},
  {"id":"82","left":30.4,"top":48,"w":3.5,"h":3.5},
  {"id":"83","left":35.5,"top":48,"w":3.5,"h":3.5},
  {"id":"84","left":40.6,"top":48,"w":3.5,"h":3.5},
  {"id":"85","left":45.7,"top":48,"w":3.5,"h":3.5},
  {"id":"86","left":50.8,"top":48,"w":3.5,"h":3.5},
  {"id":"87","left":55.9,"top":48,"w":3.5,"h":3.5},
  {"id":"88","left":61,"top":48,"w":3.5,"h":3.5},

  {"id":"89","left":17.7,"top":54,"w":3.5,"h":3.5},
  {"id":"90","left":22.8,"top":54,"w":3.5,"h":3.5},
  {"id":"91","left":27.9,"top":54,"w":3.5,"h":3.5},
  {"id":"92","left":33,"top":54,"w":3.5,"h":3.5},
  {"id":"93","left":38.1,"top":54,"w":3.5,"h":3.5},
  {"id":"94","left":43.2,"top":54,"w":3.5,"h":3.5},
  {"id":"95","left":48.3,"top":54,"w":3.5,"h":3.5},
  {"id":"96","left":53.4,"top":54,"w":3.5,"h":3.5},
  {"id":"97","left":58.5,"top":54,"w":3.5,"h":3.5},
  {"id":"98","left":63.6,"top":54,"w":3.5,"h":3.5},
  {"id":"99","left":68.7,"top":54,"w":3.5,"h":3.5},

  {"id":"100","left":18.8,"top":60,"w":3.5,"h":3.5},
  {"id":"101","left":23.9,"top":60,"w":3.5,"h":3.5},
  {"id":"102","left":29,"top":60,"w":3.5,"h":3.5},
  {"id":"103","left":34.1,"top":60,"w":3.5,"h":3.5},
  {"id":"104","left":39.2,"top":60,"w":3.5,"h":3.5},
  {"id":"105","left":44.3,"top":60,"w":3.5,"h":3.5},
  {"id":"106","left":49.4,"top":60,"w":3.5,"h":3.5},
  {"id":"107","left":54.5,"top":60,"w":3.5,"h":3.5},
  {"id":"108","left":59.6,"top":60,"w":3.5,"h":3.5},
  {"id":"109","left":64.7,"top":60,"w":3.5,"h":3.5},

  {"id":"110","left":20.9,"top":66,"w":3.5,"h":3.5},
  {"id":"111","left":26,"top":66,"w":3.5,"h":3.5},
  {"id":"112","left":31.1,"top":66,"w":3.5,"h":3.5},
  {"id":"113","left":36.2,"top":66,"w":3.5,"h":3.5},
  {"id":"114","left":41.3,"top":66,"w":3.5,"h":3.5},
  {"id":"115","left":46.4,"top":66,"w":3.5,"h":3.5},
  {"id":"116","left":51.5,"top":66,"w":3.5,"h":3.5},
  {"id":"117","left":56.6,"top":66,"w":3.5,"h":3.5},
  {"id":"118","left":61.7,"top":66,"w":3.5,"h":3.5},

  {"id":"119","left":25.6,"top":72,"w":3.5,"h":3.5},
  {"id":"120","left":30.7,"top":72,"w":3.5,"h":3.5},
  {"id":"121","left":35.8,"top":72,"w":3.5,"h":3.5},
  {"id":"122","left":40.9,"top":72,"w":3.5,"h":3.5},
  {"id":"123","left":46,"top":72,"w":3.5,"h":3.5},
  {"id":"124","left":51.1,"top":72,"w":3.5,"h":3.5},
  {"id":"125","left":56.2,"top":72,"w":3.5,"h":3.5},
  {"id":"126","left":61.3,"top":72,"w":3.5,"h":3.5},
  {"id":"127","left":66.4,"top":72,"w":3.5,"h":3.5},
  {"id":"128","left":71.5,"top":72,"w":3.5,"h":3.5},
  {"id":"129","left":76.6,"top":72,"w":3.5,"h":3.5},
  {"id":"130","left":81.7,"top":72,"w":3.5,"h":3.5},
  {"id":"131","left":86.8,"top":72,"w":3.5,"h":3.5},
  {"id":"132","left":91.9,"top":72,"w":3.5,"h":3.5},

  {"id":"133","left":29.5,"top":78,"w":3.5,"h":3.5},
  {"id":"134","left":34.6,"top":78,"w":3.5,"h":3.5},
  {"id":"135","left":39.7,"top":78,"w":3.5,"h":3.5},
  {"id":"136","left":44.8,"top":78,"w":3.5,"h":3.5},
  {"id":"137","left":49.9,"top":78,"w":3.5,"h":3.5},
  {"id":"138","left":55,"top":78,"w":3.5,"h":3.5},
  {"id":"139","left":60.1,"top":78,"w":3.5,"h":3.5},
  {"id":"140","left":65.2,"top":78,"w":3.5,"h":3.5},
  {"id":"141","left":70.3,"top":78,"w":3.5,"h":3.5},
  {"id":"142","left":75.4,"top":78,"w":3.5,"h":3.5},
  {"id":"143","left":80.5,"top":78,"w":3.5,"h":3.5},
  {"id":"144","left":85.6,"top":78,"w":3.5,"h":3.5},
  {"id":"145","left":90.7,"top":78,"w":3.5,"h":3.5},

  {"id":"146","left":32.1,"top":84,"w":3.5,"h":3.5},
  {"id":"147","left":37.2,"top":84,"w":3.5,"h":3.5},
  {"id":"148","left":42.3,"top":84,"w":3.5,"h":3.5},
  {"id":"149","left":47.4,"top":84,"w":3.5,"h":3.5},
  {"id":"150","left":52.5,"top":84,"w":3.5,"h":3.5},
  {"id":"151","left":57.6,"top":84,"w":3.5,"h":3.5},
  {"id":"152","left":62.7,"top":84,"w":3.5,"h":3.5},
  {"id":"153","left":67.8,"top":84,"w":3.5,"h":3.5},
  {"id":"154","left":72.9,"top":84,"w":3.5,"h":3.5},
  {"id":"155","left":78,"top":84,"w":3.5,"h":3.5},
  {"id":"156","left":83.1,"top":84,"w":3.5,"h":3.5},
  {"id":"157","left":88.2,"top":84,"w":3.5,"h":3.5},
  {"id":"158","left":93.3,"top":84,"w":3.5,"h":3.5},

  {"id":"159","left":35.7,"top":90,"w":3.5,"h":3.5},
  {"id":"160","left":40.8,"top":90,"w":3.5,"h":3.5},
  {"id":"161","left":45.9,"top":90,"w":3.5,"h":3.5},
  {"id":"162","left":51,"top":90,"w":3.5,"h":3.5},
  {"id":"163","left":56.1,"top":90,"w":3.5,"h":3.5},
  {"id":"164","left":61.2,"top":90,"w":3.5,"h":3.5},
  {"id":"165","left":66.3,"top":90,"w":3.5,"h":3.5},
  {"id":"166","left":71.4,"top":90,"w":3.5,"h":3.5},
  {"id":"167","left":76.5,"top":90,"w":3.5,"h":3.5},
  {"id":"168","left":81.6,"top":90,"w":3.5,"h":3.5},
  {"id":"169","left":86.7,"top":90,"w":3.5,"h":3.5},
  {"id":"170","left":80.3,"top":96,"w":3.5,"h":3.5},
  {"id":"171","left":85.4,"top":96,"w":3.5,"h":3.5},
  {"id":"172","left":90.5,"top":96,"w":3.5,"h":3.5}
];
let idCounter = 1;
rowsCounts.forEach((count, rowIdx) => {
  const top = topStart + rowIdx * rowVGap;
  // calculate horizontal spacing: center the row in available width
  const totalWidth = 100 - hallPaddingLeft - hallPaddingRight;
  const rowSpace = totalWidth;
  const usedWidth = count * seatW;
  const gapTotal = Math.max(0, rowSpace - usedWidth);
  const gapBetween = gapTotal / (count + 1);
  let x = hallPaddingLeft + gapBetween; // first seat left %
  for (let c = 0; c < count; c++) {
    SEATS_CONFIG.push({
      id: idCounter.toString(),
      left: x,
      top: top,
      w: seatW,
      h: seatH
    });
    x += seatW + gapBetween;
    idCounter++;
  }
});

let seatsState = {}; // id -> status

async function fetchSeats() {
  try {
    const res = await fetch(API_URL + '?type=getSeats');
    const j = await res.json();
    if (!j.ok) { console.error('getSeats error', j); return; }
    j.seats.forEach(s => seatsState[s.id] = s.status);
    renderSeats();
  } catch (e) { console.error('fetchSeats err', e); }
}

function renderSeats() {
  const hall = document.getElementById('hall');
  // remove old seat elements
  hall.querySelectorAll('.seat').forEach(n => n.remove());
  SEATS_CONFIG.forEach(cfg => {
    const el = document.createElement('div');
    el.className = 'seat';
    const status = seatsState[cfg.id] || 'available';
    el.classList.add(status === 'pending' ? 'pending' : (status === 'sold' ? 'sold' : 'available'));
    el.style.left = cfg.left + '%';
    el.style.top = cfg.top + '%';
    el.style.width = cfg.w + '%';
    el.style.height = cfg.h + '%';
    el.dataset.id = cfg.id;
    el.innerText = cfg.id;
    if (status !== 'sold') el.addEventListener('click', onSeatClick);
    hall.appendChild(el);
  });
}

function onSeatClick(e) {
  const id = e.currentTarget.dataset.id;
  openModal(id);
}

/* Modal logic */
const modal = document.getElementById('modal');
const buyForm = document.getElementById('buyForm');
const seatIdInput = document.getElementById('seatId');
const modalTitle = document.getElementById('modalTitle');
const cancelBtn = document.getElementById('cancelBtn');
const formMsg = document.getElementById('formMsg');

function openModal(id) {
  seatIdInput.value = id;
  modalTitle.innerText = 'Выбрано место ' + id;
  formMsg.innerText = '';
  modal.classList.add('open');
}
function closeModal() { modal.classList.remove('open'); }
cancelBtn.addEventListener('click', ()=>closeModal());

buyForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  formMsg.innerText = 'Отправка...';
  const id = seatIdInput.value;
  const name = document.getElementById('name').value.trim();
  const surname = document.getElementById('surname').value.trim();
  const email = document.getElementById('email').value.trim();
  const fileInput = document.getElementById('receipt');
  if (!name || !email || !fileInput.files.length) { formMsg.innerText = 'Заполните обязательные поля.'; return; }
  const file = fileInput.files[0];
  try {
    const base64 = await readFileAsDataURL(file);
    const payload = { type:'reserve', id: id, name: name, surname: surname, email: email, receiptBase64: base64, receiptFilename: file.name };
    const r = await fetch(API_URL, { method:'POST', body: JSON.stringify(payload), headers:{ 'Content-Type':'application/json' }});
    const j = await r.json();
    if (j.ok) {
      formMsg.innerText = 'Резерв создан — ожидает подтверждения админом.';
      await fetchSeats();
      setTimeout(()=>closeModal(),1000);
    } else formMsg.innerText = 'Ошибка: ' + (j.error||'unknown');
  } catch(err){ formMsg.innerText = 'Ошибка сети: ' + err; }
});

function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

/* initial load */
window.addEventListener('load', ()=>{ fetchSeats(); setInterval(fetchSeats, 15000); });
</script>
</body>
</html>





